<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Flappy Bird - Lab 3</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <style>
      body {
        margin: 0;
        background: #222;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
      }

      h1 {
        margin-top: 10px;
      }

      canvas {
        display: block;
        margin: 20px auto;
        border: 2px solid #000;
        background: #70c5ce;

        /* Responsywność */
        width: 100%;
        max-width: 400px;
        height: auto;

        /* blokuje domyślne gesty na telefonie */
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <h1>Flappy Bird</h1>
    <p>Sterowanie: spacja / dotknięcie ekranu = podbicie ptaka</p>

    <canvas id="gameCanvas" width="400" height="600"></canvas>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      const backgroundImg = new Image();
      backgroundImg.src = "assets/Flappy Bird/background-day.png";

      const baseImg = new Image();
      baseImg.src = "assets/Flappy Bird/base.png";

      const pipeImg = new Image();
      pipeImg.src = "assets/Flappy Bird/pipe-green.png";

      const birdFrames = [new Image(), new Image(), new Image()];
      birdFrames[0].src = "assets/Flappy Bird/yellowbird-upflap.png";
      birdFrames[1].src = "assets/Flappy Bird/yellowbird-midflap.png";
      birdFrames[2].src = "assets/Flappy Bird/yellowbird-downflap.png";

      const messageImg = new Image();
      messageImg.src = "assets/UI/message.png";

      const gameOverImg = new Image();
      gameOverImg.src = "assets/UI/gameover.png";

      const numberImgs = [];
      for (let i = 0; i <= 9; i++) {
        const img = new Image();
        img.src = "assets/UI/Numbers/" + i + ".png";
        numberImgs.push(img);
      }

      function loadSound(path) {
        const a = new Audio();
        a.src = path;
        return a;
      }

      const sndWing = loadSound("assets/Sound Efects/wing.ogg");
      const sndPoint = loadSound("assets/Sound Efects/point.ogg");
      const sndHit = loadSound("assets/Sound Efects/hit.ogg");
      const sndDie = loadSound("assets/Sound Efects/die.ogg");
      const sndSwoosh = loadSound("assets/Sound Efects/swoosh.ogg");

      const bgMusic = loadSound("assets/Sound Efects/music.mp3");
      bgMusic.loop = true;

      const gravity = 0.3;
      const flapStrength = -6;
      const pipeSpeed = 4;
      const pipeWidth = 60;
      const gapHeight = 140;

      let bird;
      let pipes;
      let score;
      let gameState = "ready";

      let frameCount = 0;
      let baseOffset = 0;

      let restartButton = { x: 0, y: 0, w: 0, h: 0 };

      const SCORE_KEY = "flappy_scores";

      function saveScore(currentScore) {
        let scores = [];
        const stored = localStorage.getItem(SCORE_KEY);
        if (stored) {
          try {
            scores = JSON.parse(stored);
          } catch (e) {
            scores = [];
          }
        }
        scores.push(currentScore);
        scores.sort(function (a, b) {
          return b - a;
        });
        scores = scores.slice(0, 5);
        localStorage.setItem(SCORE_KEY, JSON.stringify(scores));
      }

      function getBestScore() {
        const scores = getScores();
        if (scores.length === 0) return 0;
        return scores[0];
      }

      function getScores() {
        const stored = localStorage.getItem(SCORE_KEY);
        if (!stored) return [];
        try {
          const scores = JSON.parse(stored);
          if (Array.isArray(scores)) return scores;
          return [];
        } catch (e) {
          return [];
        }
      }

      function resetGame() {
        bird = {
          x: 80,
          y: canvas.height / 2,
          vy: 0,
          width: 34,
          height: 24,
          angle: 0,
        };

        pipes = [];
        score = 0;
        baseOffset = 0;

        for (let i = 0; i < 3; i++) {
          addPipe(300 + i * 200);
        }
      }

      function addPipe(x) {
        const minGapY = 100;
        const maxGapY = canvas.height - 100 - gapHeight;
        const gapY =
          Math.floor(Math.random() * (maxGapY - minGapY + 1)) + minGapY;

        pipes.push({
          x: x,
          gapY: gapY,
          width: pipeWidth,
          passed: false,
        });
      }

      function startMusic() {
        try {
          bgMusic.currentTime = 0;
          bgMusic.play();
        } catch (e) {}
      }

      function stopMusic() {
        try {
          bgMusic.pause();
          bgMusic.currentTime = 0;
        } catch (e) {}
      }

      function flap() {
        if (gameState === "ready") {
          gameState = "running";
          sndSwoosh.play().catch(function () {});
          startMusic();
        } else if (gameState === "running") {
          bird.vy = flapStrength;
          sndWing.play().catch(function () {});
        } else if (gameState === "over") {
          restartGame();
        }
      }

      function restartGame() {
        stopMusic();
        gameState = "ready";
        resetGame();
      }

      function getCanvasPosFromMouseEvent(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (e.clientX - rect.left) * scaleX,
          y: (e.clientY - rect.top) * scaleY,
        };
      }

      function getCanvasPosFromTouchEvent(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0] || e.changedTouches[0];
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (touch.clientX - rect.left) * scaleX,
          y: (touch.clientY - rect.top) * scaleY,
        };
      }

      function isInsideRestartButton(x, y) {
        return (
          x >= restartButton.x &&
          x <= restartButton.x + restartButton.w &&
          y >= restartButton.y &&
          y <= restartButton.y + restartButton.h
        );
      }

      // klawiatura – PC
      document.addEventListener("keydown", function (e) {
        if (e.code === "Space") {
          flap();
        }
      });

      // kliknięcie – PC
      canvas.addEventListener("click", function (e) {
        if (gameState === "over") {
          const pos = getCanvasPosFromMouseEvent(e);
          if (isInsideRestartButton(pos.x, pos.y)) {
            restartGame();
          }
        } else {
          flap();
        }
      });

      // DOTYK – telefon
      canvas.addEventListener(
        "touchstart",
        function (e) {
          e.preventDefault();
          if (gameState === "over") {
            const pos = getCanvasPosFromTouchEvent(e);
            if (isInsideRestartButton(pos.x, pos.y)) {
              restartGame();
            }
          } else {
            flap();
          }
        },
        { passive: false }
      );

      canvas.addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        { passive: false }
      );

      function update() {
        if (gameState === "running" || gameState === "dying") {
          updatePhysics();
        }

        draw();
        frameCount++;
        requestAnimationFrame(update);
      }

      function startDying() {
        if (gameState !== "running") return;
        gameState = "dying";
        sndHit.play().catch(function () {});
        sndDie.play().catch(function () {});
      }

      function hitGameOver() {
        if (gameState === "over") return;
        stopMusic();
        gameState = "over";
        saveScore(score);
      }

      function updatePhysics() {
        bird.vy += gravity;
        bird.y += bird.vy;

        bird.angle = Math.max(-0.6, Math.min(0.8, bird.vy / 5));

        baseOffset -= pipeSpeed;
        if (baseImg.width > 0) {
          if (baseOffset <= -baseImg.width) {
            baseOffset = 0;
          }
        }

        if (gameState === "dying") {
          const groundY = canvas.height - baseImg.height;
          if (bird.y + bird.height >= groundY) {
            bird.y = groundY - bird.height;
            hitGameOver();
          }
          return;
        }

        for (let i = 0; i < pipes.length; i++) {
          pipes[i].x -= pipeSpeed;
        }

        if (pipes.length > 0 && pipes[0].x + pipeWidth < 0) {
          pipes.shift();
          addPipe(pipes[pipes.length - 1].x + 200);
        }

        for (let i = 0; i < pipes.length; i++) {
          const p = pipes[i];

          const topPipeBottom = p.gapY;
          const bottomPipeTop = p.gapY + gapHeight;

          if (bird.x + bird.width > p.x && bird.x < p.x + p.width) {
            if (bird.y < topPipeBottom) {
              startDying();
              return;
            }
            if (bird.y + bird.height > bottomPipeTop) {
              startDying();
              return;
            }
          }

          if (!p.passed && bird.x > p.x + p.width) {
            p.passed = true;
            score++;
            sndPoint.play().catch(function () {});
          }
        }

        const groundY = canvas.height - baseImg.height;
        if (bird.y + bird.height >= groundY) {
          bird.y = groundY - bird.height;
          startDying();
        } else if (bird.y < 0) {
          hitGameOver();
        }
      }

      function drawBackground() {
        if (backgroundImg.complete && backgroundImg.width > 0) {
          ctx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);
        } else {
          ctx.fillStyle = "#70c5ce";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
      }

      function drawBase() {
        const y = canvas.height - baseImg.height;

        if (baseImg.complete && baseImg.width > 0) {
          let x = baseOffset;
          while (x < canvas.width) {
            ctx.drawImage(baseImg, x, y);
            x += baseImg.width;
          }
        } else {
          ctx.fillStyle = "#DED895";
          ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
        }
      }

      function drawPipes() {
        ctx.fillStyle = "green";

        for (let i = 0; i < pipes.length; i++) {
          const p = pipes[i];
          const topPipeHeight = p.gapY;
          const bottomPipeY = p.gapY + gapHeight;
          const bottomPipeHeight = canvas.height - bottomPipeY;

          if (pipeImg.complete && pipeImg.width > 0) {
            ctx.drawImage(pipeImg, p.x, 0, p.width, topPipeHeight);
            ctx.drawImage(pipeImg, p.x, bottomPipeY, p.width, bottomPipeHeight);
          } else {
            ctx.fillRect(p.x, 0, p.width, topPipeHeight);
            ctx.fillRect(p.x, bottomPipeY, p.width, bottomPipeHeight);
          }
        }
      }

      function drawBird() {
        const frameIndex = Math.floor(frameCount / 10) % 3;
        const img = birdFrames[frameIndex];

        ctx.save();
        const centerX = bird.x + bird.width / 2;
        const centerY = bird.y + bird.height / 2;
        ctx.translate(centerX, centerY);
        ctx.rotate(bird.angle || 0);

        if (img.complete && img.width > 0) {
          ctx.drawImage(
            img,
            -bird.width / 2,
            -bird.height / 2,
            bird.width,
            bird.height
          );
        } else {
          ctx.fillStyle = "yellow";
          ctx.fillRect(
            -bird.width / 2,
            -bird.height / 2,
            bird.width,
            bird.height
          );
        }
        ctx.restore();
      }

      function drawScore(scoreValue, centerX, y) {
        const text = String(scoreValue);
        const digitWidth = 24;
        const digitHeight = 36;

        const totalWidth = text.length * digitWidth;
        let x = centerX - totalWidth / 2;

        for (let i = 0; i < text.length; i++) {
          const d = parseInt(text.charAt(i), 10);
          const img = numberImgs[d];
          if (img && img.complete && img.width > 0) {
            ctx.drawImage(img, x, y, digitWidth, digitHeight);
          } else {
            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.fillText(text.charAt(i), x, y + digitHeight);
          }
          x += digitWidth;
        }
      }

      function drawUI() {
        if (gameState === "ready") {
          if (messageImg.complete && messageImg.width > 0) {
            const w = messageImg.width;
            const h = messageImg.height;
            const scale = 0.8;
            const dw = w * scale;
            const dh = h * scale;
            ctx.drawImage(
              messageImg,
              canvas.width / 2 - dw / 2,
              canvas.height / 4,
              dw,
              dh
            );
          }

          ctx.fillStyle = "#000";
          ctx.font = "18px Arial";
          ctx.fillText(
            "Naciśnij spację / dotknij, aby rozpocząć",
            20,
            canvas.height - 80
          );
        }

        if (gameState === "over") {
          if (gameOverImg.complete && gameOverImg.width > 0) {
            const w = gameOverImg.width;
            const h = gameOverImg.height;
            const scale = 0.8;
            const dw = w * scale;
            const dh = h * scale;
            ctx.drawImage(
              gameOverImg,
              canvas.width / 2 - dw / 2,
              canvas.height / 4,
              dw,
              dh
            );
          } else {
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(40, canvas.height / 3, canvas.width - 80, 150);
            ctx.fillStyle = "white";
            ctx.font = "32px Arial";
            ctx.fillText(
              "GAME OVER",
              canvas.width / 2 - 90,
              canvas.height / 3 + 50
            );
          }

          const best = getBestScore();
          drawScore(score, canvas.width - 40, 20);

          ctx.fillStyle = "#000";
          ctx.font = "18px Arial";
          ctx.fillText(
            "Najlepszy wynik: " + best,
            canvas.width / 2 - 90,
            canvas.height / 2 + 10
          );

          const scores = getScores();
          ctx.font = "16px Arial";
          ctx.fillText(
            "TOP 5 wyników:",
            canvas.width / 2 - 70,
            canvas.height / 2 + 40
          );
          for (let i = 0; i < scores.length; i++) {
            const line = i + 1 + ". " + scores[i];
            ctx.fillText(
              line,
              canvas.width / 2 - 60,
              canvas.height / 2 + 60 + i * 18
            );
          }

          const btnWidth = 180;
          const btnHeight = 40;
          const btnX = canvas.width / 2 - btnWidth / 2;
          const btnY = canvas.height / 2 + 60 + 5 * 18 + 20;

          restartButton.x = btnX;
          restartButton.y = btnY;
          restartButton.w = btnWidth;
          restartButton.h = btnHeight;

          ctx.fillStyle = "#ffa500";
          ctx.fillRect(btnX, btnY, btnWidth, btnHeight);
          ctx.strokeStyle = "#000";
          ctx.strokeRect(btnX, btnY, btnWidth, btnHeight);

          ctx.fillStyle = "#000";
          ctx.font = "18px Arial";
          ctx.fillText("Zagraj ponownie", btnX + 20, btnY + 26);
        }
      }

      function draw() {
        drawBackground();
        drawPipes();
        drawBase();
        drawBird();

        if (gameState === "running" || gameState === "dying") {
          drawScore(score, canvas.width - 40, 20);
        }

        drawUI();
      }

      resetGame();
      update();
    </script>
  </body>
</html>
